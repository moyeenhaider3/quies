---
phase: 09-ux-polish-author
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/features/quotes/presentation/pages/quote_feed_screen.dart
autonomous: true

must_haves:
  truths:
    - "Mood selector bottom sheet shows tag chips under each mood"
    - "Tapping a mood label applies all its mapped tags (broad filter)"
    - "Tapping an individual tag chip narrows filter to just that tag"
    - "Tag chips are sourced from moodToTagsMap in genre_mapping.dart"
  artifacts:
    - path: "lib/features/quotes/presentation/pages/quote_feed_screen.dart"
      provides: "Updated _showMoodSelector with tag chips under each mood"
  key_links:
    - from: "lib/features/quotes/presentation/pages/quote_feed_screen.dart"
      to: "lib/features/music/data/genre_mapping.dart"
      via: "import moodToTagsMap"
      pattern: "moodToTagsMap"
    - from: "_showMoodSelector tag chip onTap"
      to: "FeedBloc"
      via: "ApplyTagFilter event dispatch"
      pattern: "ApplyTagFilter"
---

<objective>
Add tag chip visibility under each mood in the mood selector bottom sheet, with individual tag tap filtering.

Purpose: Users currently see only mood labels (e.g., "Calm"). Showing the underlying tags (wisdom, nature, philosophy) provides transparency and allows precise filtering by individual tag.
Output: Updated _showMoodSelector in quote_feed_screen.dart with tag chips and individual tag tap behavior.
</objective>

<execution_context>
@.planning/phases/09-ux-polish-author/09-CONTEXT.md
@.planning/phases/09-ux-polish-author/09-RESEARCH.md
</execution_context>

<context>
@.planning/PROJECT.md

Key files to read:
@lib/features/quotes/presentation/pages/quote_feed_screen.dart (L150-235 _showMoodSelector method)
@lib/features/music/data/genre_mapping.dart (L92-103 moodToTagsMap)
@lib/features/quotes/presentation/bloc/feed_event.dart (ApplyTagFilter, ChangeMood events)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tag chips under moods in _showMoodSelector</name>
  <files>lib/features/quotes/presentation/pages/quote_feed_screen.dart</files>
  <action>
Modify the `_showMoodSelector` method in `_QuoteFeedScreenState`:

1. **Add import** at top of file:
   `import '../../../music/data/genre_mapping.dart';` (for `moodToTagsMap`)

2. **Update the mood item layout** inside the `Wrap` children `.map()`:
   Currently each mood renders as a `GestureDetector` → `Container` → `Row(emoji, label)`.
   Change to a `Column` wrapping:
   - The existing `GestureDetector` → `Container` → `Row(emoji, label)` (mood label area — unchanged tap behavior, dispatches `ChangeMood(label)`)
   - Below it: a `Wrap` of tag chips from `moodToTagsMap[label] ?? []`

3. **Tag chip layout:**
   Each tag chip is a `GestureDetector` wrapping a small `Container`:
   - Padding: `EdgeInsets.symmetric(horizontal: 8, vertical: 4)`
   - Decoration: transparent background with subtle border (`Colors.white.withValues(alpha: 0.08)` dark / `Colors.black.withValues(alpha: 0.04)` light), borderRadius 10
   - Child: `Text(tag)` with `GoogleFonts.outfit(fontSize: 11, color: isDark ? Colors.white38 : Colors.black38)`
   - Min tap area: ensure `Container` has at least 28px height via `constraints: BoxConstraints(minHeight: 28)`
   - `onTap`: dispatch `context.read<FeedBloc>().add(ApplyTagFilter([tag]))` and then `Navigator.pop(context)` to close the sheet

4. **Tag chip Wrap config:**
   - `spacing: 6`, `runSpacing: 4`
   - Add `const SizedBox(height: 6)` between mood label and tag chips
   - Constrain width so tags don't overflow: wrap the entire mood Column in a `SizedBox` or `ConstrainedBox` if needed, but the outer `Wrap` of moods should handle it naturally since moods already use `MainAxisSize.min`

5. **Important:** The mood label `GestureDetector.onTap` still dispatches `ChangeMood(label)` — do NOT change this. Only the individual tag chips dispatch `ApplyTagFilter`.

6. **Note on _moods list:** Currently `_moods` is a `List<(String, String)>` of `(label, emoji)` tuples. The `moodToTagsMap` uses the label as key — they already correspond (Calm, Energized, Reflective, Anxious, Grateful, Hopeful, Stressed, Tired). Only show tags for moods that exist in `moodToTagsMap`.
  </action>
  <verify>
Run `dart analyze lib/features/quotes/presentation/pages/quote_feed_screen.dart` — no errors.
Verify `moodToTagsMap` import resolves.
Verify each mood shows its tag chips below the label in the bottom sheet.
  </verify>
  <done>Mood selector shows tag chips under each mood. Tapping mood dispatches ChangeMood (broad). Tapping individual tag dispatches ApplyTagFilter (narrow) and closes sheet.</done>
</task>

</tasks>

<verification>
1. `dart analyze lib/` passes
2. Mood selector bottom sheet shows tag chips under each mood label
3. Tapping "Calm" mood still dispatches `ChangeMood('Calm')`
4. Tapping "wisdom" tag chip dispatches `ApplyTagFilter(['wisdom'])` and closes sheet
5. Tag data comes from `moodToTagsMap` (no hardcoded tags)
6. Tags render with sufficient touch target (≥28px height)
</verification>

<success_criteria>
- Mood selector shows grouped tags under each mood
- Two tap behaviors work: mood-level (broad) and tag-level (narrow)
- No visual overflow or spacing issues
- dart analyze clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-ux-polish-author/09-02-SUMMARY.md`
</output>
